<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Health Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Used for all icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { font-family: 'Inter', sans-serif; }
        .header-gradient {
            background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
        }
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(129, 140, 248, 0.5), 0 4px 6px -2px rgba(129, 140, 248, 0.05);
        }
        /* Custom scrollbar for history boxes */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f3f4f6; /* gray-100 */
        }
        /* Ensure inputs look clean */
        input[type="date"], input[type="number"], textarea {
            transition: all 0.15s ease-in-out;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            z-index: 60;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <div id="app-container" class="max-w-md mx-auto">
        
        <div id="main-content">
            <!-- Header -->
            <header class="header-gradient p-6 rounded-b-3xl shadow-custom">
                <h1 class="text-2xl font-extrabold text-white">Yours Womens Health Tracker</h1>
                <p class="text-sm text-indigo-100 mt-1">Cycle, Thyroid, and AI Guidance.</p>
                <p id="user-id-display" class="text-xs text-indigo-200 mt-2 opacity-70"></p>
            </header>

            <main class="p-4 pt-0">
                <!-- Error Banner -->
                <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4" role="alert">
                    <p class="font-bold">System Error</p>
                    <p id="error-message" class="text-sm"></p>
                </div>

                <!-- 1. Cycle Metrics & Status -->
                <section class="mt-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Cycle Metrics</h2>
                    <div id="cycle-stats" class="grid grid-cols-2 gap-3">
                        <!-- Stat Cards will be rendered here -->
                    </div>
                    <div id="cycle-status" class="mt-4 text-center bg-yellow-50 text-yellow-700 py-2 px-3 rounded-lg text-sm font-medium">
                        Cycle Status: Loading...
                    </div>
                    <div id="cycle-chart-container" class="mt-6">
                        <!-- Chart will be rendered here -->
                    </div>
                </section>

                <!-- 2. Latest Thyroid Status -->
                <section class="mb-6 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <i data-lucide="microscope" class="w-5 h-5 text-teal-600 mr-2"></i>
                        Latest Thyroid Report
                    </h2>
                    <div id="latest-thyroid-status">
                        <div class="text-center py-4 text-sm text-gray-500 bg-gray-50 rounded-lg">
                            No thyroid reports logged.
                        </div>
                    </div>
                </section>

                <!-- 3. Log New Period Form -->
                <section class="mb-6 p-4 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <i data-lucide="droplet" class="w-5 h-5 text-red-500 mr-2"></i>
                        Log New Period
                    </h2>
                    <form id="cycle-form">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                                <input type="date" id="startDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 p-2 border" required>
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
                                <input type="date" id="endDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 p-2 border" required>
                            </div>
                        </div>
                        <p id="cycle-form-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        <button type="submit" id="log-cycle-btn" class="w-full mt-4 py-3 px-4 rounded-xl font-semibold transition duration-300 shadow-lg bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-300/50">
                            Record Cycle
                        </button>
                    </form>
                </section>

                <!-- 4. Log Lab Reports Form -->
                <section class="mb-6 p-4 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <i data-lucide="microscope" class="w-5 h-5 text-teal-600 mr-2"></i>
                        Log Lab Report (TSH, T3, T4, CBC)
                    </h2>
                    <form id="lab-report-form">
                        <div class="space-y-3">
                            <div>
                                <label for="reportDate" class="block text-sm font-medium text-gray-700">Report Date</label>
                                <input type="date" id="reportDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition duration-150 p-2 border" required>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label for="tsh" class="block text-sm font-medium text-gray-700">TSH</label>
                                    <input type="number" step="0.01" id="tsh" placeholder="e.g., 2.5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border" required>
                                </div>
                                <div>
                                    <label for="t3" class="block text-sm font-medium text-gray-700">Free T3</label>
                                    <input type="number" step="0.1" id="t3" placeholder="e.g., 3.2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border" required>
                                </div>
                                <div>
                                    <label for="t4" class="block text-sm font-medium text-gray-700">Free T4</label>
                                    <input type="number" step="0.1" id="t4" placeholder="e.g., 1.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border" required>
                                </div>
                            </div>
                            <div>
                                <label for="cbcDetails" class="block text-sm font-medium text-gray-700">CBC / Notes (Optional)</label>
                                <textarea id="cbcDetails" placeholder="e.g., Hemoglobin is slightly low." rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border"></textarea>
                            </div>
                        </div>
                        <p id="lab-form-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        <button type="submit" id="log-lab-btn" class="w-full mt-4 py-3 px-4 rounded-xl font-semibold transition duration-300 shadow-lg bg-teal-600 text-white hover:bg-teal-700 shadow-teal-300/50">
                            Record Lab Report
                        </button>
                    </form>
                </section>

                <!-- 5. AI Gynecologist Advisor -->
                <section class="mb-6 p-4 bg-indigo-50 rounded-xl shadow-lg border border-indigo-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <i data-lucide="zap" class="w-5 h-5 text-indigo-600 mr-2"></i>
                        Health Advisor
                    </h2>
                    <div id="ai-advice-display" class="bg-white p-3 rounded-lg border border-indigo-100 whitespace-pre-wrap text-sm text-gray-700 min-h-[4rem]">
                        Log some data and click below for a holistic health assessment.
                    </div>
                    <button id="fetch-advice-btn" class="w-full mt-3 py-2 px-4 rounded-lg font-medium text-sm transition duration-300 bg-indigo-500 text-white hover:bg-indigo-600">
                        Get Holistic Health Assessment
                    </button>
                </section>

                <!-- 6. History Logs -->
                <section class="mb-6 p-4 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">History</h2>
                    
                    <!-- Lab Report History -->
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Thyroid & Lab Reports</h3>
                    <div id="lab-report-history" class="max-h-48 overflow-y-auto custom-scroll pr-2 mb-4">
                        <div class="text-center py-4 text-sm text-gray-500">Loading...</div>
                    </div>

                    <!-- Cycle History -->
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">Menstrual Cycles</h3>
                    <div id="cycle-history" class="max-h-48 overflow-y-auto custom-scroll pr-2">
                        <div class="text-center py-4 text-sm text-gray-500">Loading...</div>
                    </div>

                    <button id="clear-data-btn" class="w-full mt-6 py-2 px-4 rounded-xl font-semibold transition duration-300 shadow-md bg-red-500 text-white hover:bg-red-600 shadow-red-300/50 flex items-center justify-center">
                        Clear All Data (Local)
                    </button>
                </section>

            </main>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (Hidden by Default) -->
    <div id="confirmation-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full mx-4 transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold text-red-600 flex items-center mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                Confirm Deletion
            </h3>
            <p class="text-gray-700 mb-6 text-sm">
                Are you absolutely sure you want to delete **ALL** cycle and thyroid data? This action is permanent and cannot be undone.
            </p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                    Yes, Delete Everything
                </button>
            </div>
        </div>
    </div>

    <!-- Application Logic (Using Local Storage) -->
    <script type="module">
        // --- API KEY CONFIGURATION ---
        // PASTE YOUR GEMINI API KEY HERE to enable the AI Advisor.
        // If left empty, the app will fall back to the simple "Rule-Based Advisor".
        const apiKey = ""; // <-- PASTE YOUR GEMINI API KEY HERE

        // --- Global Config & Constants ---
        // Standard Reference Ranges for UI check
        const TSH_MIN = 0.4; 
        const TSH_MAX = 4.0; 
        
        // Local Storage Keys
        const STORAGE_KEYS = {
            CYCLES: 'holisticTrackerCycles',
            LAB_REPORTS: 'holisticTrackerLabReports'
        };

        // --- Application State ---
        let state = {
            cycles: [],
            labReports: [],
            stats: { avgCycleLength: 0, avgPeriodLength: 0, predictedNextPeriod: null, predictedOvulation: null, healthStatus: 'Collecting data...', cycleHistoryData: [] },
            latestThyroidStatus: { status: "No Data", report: null, color: "text-gray-500", icon: "Microscope" },
            userId: 'LOCAL_USER_12345', // Dummy ID for UI, since there is no server authentication
            loadingData: true,
            loadingAI: false,
            aiAdvice: null,
            error: null,
        };

        // --- Local Storage Utilities ---

        const loadData = (key) => {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        };

        const saveData = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        const generateId = () => {
            // Simple unique ID generator for local storage records
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        };

        const clearAllData = () => {
            localStorage.removeItem(STORAGE_KEYS.CYCLES);
            localStorage.removeItem(STORAGE_KEYS.LAB_REPORTS);
            
            // Re-initialize state to default/empty values
            initializeLocalStorage();

            // Clear AI Advice display as it is now irrelevant
            updateState({ aiAdvice: "Data successfully cleared. Start logging your new cycles and reports!" });
        }
        
        // --- Utility Functions ---

        const parseDate = (dateString) => {
            // Ensures date is parsed correctly, handles local time zone issues
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return null;
            // Create a new date object in UTC to avoid time zone shifts
            const utcDate = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
            return utcDate.toISOString().split('T')[0];
        };

        const updateState = (updates) => {
            state = { ...state, ...updates };
            renderApp();
        };

        const setAppError = (message) => {
            updateState({ error: message });
        };
        
        // --- Cycle Calculation Logic ---

        const calculateStatsAndPredictions = (cycles) => {
            const cycleHistoryData = [];
            
            // Ensure cycles are sorted newest to oldest for correct logic
            const sortedNewestFirst = [...cycles].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            if (sortedNewestFirst.length === 0) {
                 return {
                    avgCycleLength: 0,
                    avgPeriodLength: 0,
                    predictedNextPeriod: null,
                    predictedOvulation: null,
                    healthStatus: "No data yet.",
                    cycleHistoryData: [],
                };
            }

            const allPeriodLengths = [];
            let lastPeriodLength = 0;
            if (sortedNewestFirst.length > 0) {
                const lastPeriod = sortedNewestFirst[0];
                lastPeriodLength = (new Date(lastPeriod.endDate).getTime() - new Date(lastPeriod.startDate).getTime()) / (1000 * 60 * 60 * 24) + 1;
                cycleHistoryData.push({ cycleNumber: sortedNewestFirst.length, startDate: lastPeriod.startDate, length: 0, periodLength: Math.round(lastPeriodLength) });
            }

            // Calculate all period lengths
            sortedNewestFirst.forEach(cycle => {
                allPeriodLengths.push((new Date(cycle.endDate).getTime() - new Date(cycle.startDate).getTime()) / (1000 * 60 * 60 * 24) + 1);
            });
            const avgPeriodLength = Math.round(allPeriodLengths.reduce((sum, len) => sum + len, 0) / allPeriodLengths.length);
            
            // Need at least 2 cycles to calculate a cycle length
            if (sortedNewestFirst.length < 2) {
                const lastStartDate = new Date(sortedNewestFirst[0].startDate);
                const defaultCycleLength = 28;
                return {
                    avgCycleLength: 0, // Not enough data
                    avgPeriodLength: avgPeriodLength, 
                    predictedNextPeriod: parseDate(new Date(lastStartDate.getTime() + (defaultCycleLength * 24 * 60 * 60 * 1000)).toISOString()),
                    predictedOvulation: parseDate(new Date(lastStartDate.getTime() + ((defaultCycleLength - 14) * 24 * 60 * 60 * 1000)).toISOString()),
                    healthStatus: "Collecting data...",
                    cycleHistoryData: cycleHistoryData,
                };
            }

            // Sort cycles oldest to newest for calculation
            const sortedCycles = [...cycles].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            const cycleLengths = [];

            for (let i = 0; i < sortedCycles.length - 1; i++) {
                const startCurrent = new Date(sortedCycles[i].startDate);
                const startNext = new Date(sortedCycles[i + 1].startDate);
                
                const diffDays = (startNext.getTime() - startCurrent.getTime()) / (1000 * 60 * 60 * 24);
                cycleLengths.push(diffDays);

                // Update cycleHistoryData for all but the last period (which was added above)
                if (i < sortedCycles.length - 1) {
                     const existingEntry = cycleHistoryData.find(c => c.startDate === sortedCycles[i].startDate);
                     if (existingEntry) {
                        existingEntry.length = diffDays;
                     }
                }
            }
            
            const avgCycleLength = Math.round(cycleLengths.reduce((sum, len) => sum + len, 0) / cycleLengths.length);

            const lastPeriodStart = new Date(sortedCycles[sortedCycles.length - 1].startDate);
            const nextPeriodTimestamp = lastPeriodStart.getTime() + (avgCycleLength * 24 * 60 * 60 * 1000);
            const predictedNextPeriod = new Date(nextPeriodTimestamp).toISOString().split('T')[0];
            const ovulationTimestamp = nextPeriodTimestamp - (14 * 24 * 60 * 60 * 1000); // Ovulation is ~14 days *before* next period
            const predictedOvulation = new Date(ovulationTimestamp).toISOString().split('T')[0];
            
            let status = "Normal";
            if (avgCycleLength < 21 || avgCycleLength > 35) {
                status = "Irregular Cycle Length";
            } else if (avgPeriodLength < 2 || avgPeriodLength > 7) {
                status = "Atypical Period Duration";
            }

            // Reverse history data so newest cycle (even if length is 0) is first
            cycleHistoryData.reverse(); 

            return {
                avgCycleLength,
                avgPeriodLength,
                predictedNextPeriod,
                predictedOvulation,
                healthStatus: status,
                cycleHistoryData: cycleHistoryData, 
            };
        };

        const getLatestThyroidStatus = (reports) => {
            if (reports.length === 0) return { status: "No Data", report: null, color: "text-gray-500", icon: "microscope" };
            
            // Reports are already sorted newest first
            const latest = reports[0];
            let status = "TSH within normal range";
            let color = "text-green-600";
            let icon = "check-circle";

            if (latest.tsh < TSH_MIN) {
                status = `TSH Low (${latest.tsh} < ${TSH_MIN}) - Hyper-T indication`;
                color = "text-red-500";
                icon = "alert-triangle";
            } else if (latest.tsh > TSH_MAX) {
                status = `TSH High (${latest.tsh} > ${TSH_MAX}) - Hypo-T indication`;
                color = "text-red-500";
                icon = "alert-triangle";
            } else if (latest.tsh >= TSH_MAX - 1.0 && latest.tsh < TSH_MAX) {
                status = "TSH Near Upper Limit (Optimal range concern)";
                color = "text-yellow-600";
                icon = "trending-up";
            }

            return { 
                status: status, 
                report: latest,
                color: color,
                icon: icon,
            };
        };

        // --- (NEW) Rule-Based Advisor (Fallback) ---
        
        /**
         * Generates simple, rule-based advice if no API key is provided.
         */
        function getRuleBasedAdvice() {
            updateState({ loadingAI: true }); // Show a brief spinner

            const stats = state.stats;
            const thyroid = state.latestThyroidStatus;
            let advicePoints = [];

            // 1. Check for data
            if (state.cycles.length === 0) {
                advicePoints.push('<li>Log at least one period to start receiving cycle analysis.</li>');
            }
            if (state.labReports.length === 0) {
                advicePoints.push('<li>Log a thyroid report to include lab analysis.</li>');
            }

            // 2. Analyze Thyroid
            if (thyroid.report) {
                if (thyroid.report.tsh > TSH_MAX) {
                    advicePoints.push(`<li><strong>Thyroid Observation:</strong> Your TSH (<strong>${thyroid.report.tsh}</strong>) is above the typical range (>${TSH_MAX}). This may indicate an underactive thyroid (hypothyroidism), which can sometimes be linked to irregular or heavy periods.</li>`);
                } else if (thyroid.report.tsh < TSH_MIN) {
                    advicePoints.push(`<li><strong>Thyroid Observation:</strong> Your TSH (<strong>${thyroid.report.tsh}</strong>) is below the typical range (<${TSH_MIN}). This may indicate an overactive thyroid (hyperthyroidism), which can sometimes be linked to light or missed periods.</li>`);
                } else {
                    advicePoints.push(`<li><strong>Thyroid Observation:</strong> Your TSH (<strong>${thyroid.report.tsh}</strong>) is within the normal range. This is a great sign!</li>`);
                }
            }

            // 3. Analyze Cycle Length
            if (stats.avgCycleLength > 0) {
                if (stats.avgCycleLength > 35 || stats.avgCycleLength < 21) {
                    advicePoints.push(`<li><strong>Cycle Observation:</strong> Your average cycle length (<strong>${stats.avgCycleLength} days</strong>) is outside the typical 21-35 day range. This suggests cycle irregularity.</li>`);
                } else {
                    advicePoints.push(`<li><strong>Cycle Observation:</strong> Your average cycle length (<strong>${stats.avgCycleLength} days</strong>) is within the typical 21-35 day range.</li>`);
                }
            } else if (state.cycles.length > 0) {
                 advicePoints.push('<li><strong>Cycle Observation:</strong> Log at least one more period to calculate your average cycle length.</li>');
            }

            // 4. Analyze Period Length
            if (stats.avgPeriodLength > 0) {
                if (stats.avgPeriodLength > 7 || stats.avgPeriodLength < 2) {
                     advicePoints.push(`<li><strong>Period Observation:</strong> Your average period duration (<strong>${stats.avgPeriodLength} days</strong>) is outside the typical 2-7 day range.</li>`);
                } else {
                     advicePoints.push(`<li><strong>Period Observation:</strong> Your average period duration (<strong>${stats.avgPeriodLength} days</strong>) is within the typical 2-7 day range.</li>`);
                }
            }

            // 5. Final Formatting
            let htmlResult = `
                <strong class="text-indigo-600">Rule-Based Health Observations:</strong>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    ${advicePoints.length > 0 ? advicePoints.join('') : '<li>No data logged yet.</li>'}
                </ul>
                <hr class="my-3">
                <p class="text-xs text-gray-500 italic">This is a basic analysis. For holistic AI advice that analyzes how these factors interact, please add a Gemini API key to the code (line 410).</p>
            `;

            // Use a slight delay to simulate "thinking"
            setTimeout(() => {
                updateState({ aiAdvice: htmlResult, loadingAI: false });
            }, 500); // 0.5 second delay
        }


        // --- AI Advisor API Interaction ---

        const fetchAiAdvice = async () => {
            // This function now assumes the API key *exists* because the gatekeeper checked it.
            // The check below is a final safeguard.
            if (!apiKey) {
                 updateState({ 
                    aiAdvice: "API Key is missing.\n\nPlease paste your Gemini API Key into the 'apiKey' variable at the top of the script (line 410) to enable the AI Advisor.",
                    loadingAI: false 
                });
                console.error("Gemini API Key is missing.");
                return;
            }

            if (state.cycles.length === 0) {
                updateState({ aiAdvice: "Please log at least one period before consulting the AI Specialist!" });
                return;
            }

            updateState({ loadingAI: true, aiAdvice: "Analyzing combined hormonal data..." });

            const stats = state.stats;
            const latestThyroidStatus = state.latestThyroidStatus;
            
            // Construct thyroid data for prompt
            let thyroidData = "No recent thyroid reports logged.";
            if (latestThyroidStatus.report) {
                const report = latestThyroidStatus.report;
                thyroidData = `
                    **Latest Thyroid Report (${report.reportDate}):**
                    - TSH: ${report.tsh} mIU/L (UI Status: ${latestThyroidStatus.status})
                    - Free T3: ${report.t3}
                    - Free T4: ${report.t4}
                    - CBC Notes: ${report.cbcDetails || 'Not specified.'}
                `;
            }

            const userQuery = `
                Please analyze the user's cycle data AND thyroid reports and provide advice, acting as a supportive hormonal health specialist and gynecologist.
                
                **Menstrual Summary Statistics:**
                - Average Cycle Length: ${stats.avgCycleLength} days
                - Average Period Length: ${stats.avgPeriodLength} days
                - Cycle Status: ${stats.healthStatus}

                ${thyroidData}
                
                Based on this combined data, provide:
                1. A brief, encouraging assessment of the combined cycle and thyroid health. Highlight any connections or potential interactions.
                2. Specific, actionable advice or suggestions for improving hormonal balance, diet, or lifestyle, taking the thyroid status into account.
                3. A note on what key indicators to watch out for in future cycles and reports.
                
                Keep the response warm, professional, and concise (under 300 words).
            `;

            const systemPrompt = "You are a world-class, empathetic hormonal health specialist and gynecologist. Analyze the provided menstrual cycle data and thyroid reports to offer personalized, clear, and actionable health advice. Your tone must be warm, professional, and encouraging. Use Google Search grounding to ensure advice aligns with current medical and wellness standards.";
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let response = null;
            let retries = 0;
            const MAX_RETRIES = 3;

            while (retries < MAX_RETRIES) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        updateState({ aiAdvice: text || "Sorry, I couldn't generate advice right now. Please try again." });
                        break;
                    } else {
                        console.error(`Gemini API call failed with status: ${response.status}`);
                        const errorText = await response.text();
                        console.error("API Error Response:", errorText);
                        // (NEW) Handle 403 specifically
                        if (response.status === 403) {
                             updateState({ aiAdvice: "AI Advisor Error: Access Denied (403).\n\nPlease check that your API key is correct, valid, and has the Gemini API enabled in your Google Cloud project.", loadingAI: false });
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        break; // Stop retrying on auth error
                    }
                } catch (error) {
                    console.error('Error fetching AI advice:', error);
                    retries++;
                    if (retries < MAX_RETRIES) {
                        const delay = Math.pow(2, retries) * 1000; 
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        updateState({ aiAdvice: "I'm sorry, an error occurred while connecting to the AI specialist. Please try again later." });
                        break;
                    }
                }
            }
            updateState({ loadingAI: false });
        };
        
        // --- (NEW) Gatekeeper Function ---
        
        /**
         * Checks for an API key and routes to the correct advisor function.
         */
        function getHolisticHealthAssessment() {
            if (apiKey) {
                // API Key exists, call the full AI
                fetchAiAdvice();
            } else {
                // No API Key, use the fallback
                getRuleBasedAdvice();
            }
        }


        // --- DOM Rendering Functions ---

        const renderStatCard = (iconName, title, value, color) => {
            const iconHtml = `<i data-lucide="${iconName}" class="w-6 h-6 mb-2 ${color}"></i>`;
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 flex flex-col items-center text-center">
                    ${iconHtml}
                    <div class="text-xl font-bold text-gray-800">${value || '---'}</div>
                    <div class="text-xs font-medium text-gray-500 uppercase mt-1">${title}</div>
                </div>
            `;
        };

        const renderCycleChart = (data, avgLength) => {
            const calculableCycles = data.filter(d => d.length > 0);
            const historyToShow = calculableCycles.slice(0, 8).reverse(); 

            if (historyToShow.length < 2) {
                return `
                    <div class="p-4 text-center text-sm text-gray-500 bg-gray-50 rounded-lg">
                        <p>Log at least two periods to see the Cycle Length Trend chart.</p>
                    </div>
                `;
            }

            const maxDataValue = Math.max(45, ...historyToShow.map(d => d.length));
            const scaleFactor = 100 / maxDataValue; 

            let barsHtml = historyToShow.map((item, index) => {
                const barHeight = item.length * scaleFactor;
                const isIrregular = item.length < 21 || item.length > 35;
                const cycleLabel = `C-${item.cycleNumber}`;
                
                return `
                    <div class="flex flex-col items-center w-8 mx-1 group relative">
                        <div 
                            class="w-full rounded-t-lg transition-all duration-300 ease-out ${isIrregular ? 'bg-red-400' : 'bg-indigo-500'}" 
                            style="height: ${barHeight}%;"
                        ></div>
                        <span class="text-[10px] text-gray-700 mt-1 font-medium">${item.length}</span>
                        <span class="text-[8px] text-gray-500 uppercase mt-1">${cycleLabel}</span>
                    </div>
                `;
            }).join('');


            return `
                <div class="p-4 bg-white rounded-xl shadow-inner border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 text-purple-500 mr-2"></i>
                        Cycle Length Trend
                    </h3>
                    <div class="relative h-48 flex items-end justify-around border-b border-l border-gray-300 pl-4 pr-2">
                        <!-- Y-Axis Labels -->
                        <div class="absolute left-0 bottom-0 top-0 w-8 flex flex-col justify-between text-xs text-gray-500 -translate-x-full">
                            <div class="h-0 text-right">~${maxDataValue}d</div>
                            <div class="h-0 text-right">~${Math.round(maxDataValue/2)}d</div>
                            <div class="h-0 text-right pb-1">0d</div>
                        </div>
                        
                        <!-- Average Line -->
                        ${avgLength > 0 ? `
                        <div 
                            class="absolute inset-x-0 border-t border-dashed border-green-500" 
                            style="bottom: ${avgLength * scaleFactor}%;"
                        >
                            <span class="absolute right-0 top-1/2 -mt-3 text-xs text-green-700 bg-white px-1 rounded-md opacity-90">
                                Avg: ${avgLength}d
                            </span>
                        </div>
                        ` : ''}
                        <!-- Data Bars Container -->
                        ${barsHtml}
                    </div>
                    <p class="text-xs text-gray-500 text-center mt-3">Showing ${historyToShow.length} most recent cycles.</p>
                </div>
            `;
        };
        
        const renderThyroidStatus = (statusObj) => {
            if (!statusObj.report) {
                 return `
                    <div class="text-center py-4 text-sm text-gray-500 bg-gray-50 rounded-lg">
                        No thyroid reports logged.
                    </div>
                 `;
            }

            const report = statusObj.report;
            const isAbnormal = statusObj.color.includes('red') || statusObj.color.includes('yellow');
            
            return `
                <div class="bg-teal-50 p-4 rounded-lg">
                    <p class="text-xs text-teal-700 font-semibold mb-2">Report Date: ${report.reportDate}</p>
                    <div class="grid grid-cols-3 text-center gap-2">
                        <div class="p-2 bg-white rounded-lg shadow-sm">
                            <p class="text-xs text-gray-500">TSH</p>
                            <p class="font-bold text-lg text-teal-700">${report.tsh}</p>
                        </div>
                        <div class="p-2 bg-white rounded-lg shadow-sm">
                            <p class="text-xs text-gray-500">Free T3</p>
                            <p class="font-bold text-lg text-teal-700">${report.t3}</p>
                        </div>
                        <div class="p-2 bg-white rounded-lg shadow-sm">
                            <p class="text-xs text-gray-500">Free T4</p>
                            <p class="font-bold text-lg text-teal-700">${report.t4}</p>
                        </div>
                    </div>
                    <div class="mt-3 text-center py-2 px-3 rounded-lg text-sm font-medium ${isAbnormal ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                        <i data-lucide="${statusObj.icon}" class="w-4 h-4 inline mr-1"></i>
                        TSH Status: ${statusObj.status}
                    </div>
                    ${report.cbcDetails ? `<p class="mt-2 text-xs text-gray-600 italic">CBC Notes: ${report.cbcDetails}</p>` : ''}
                </div>
            `;
        };

        const renderHistoryItem = (item, type) => {
            if (type === 'cycle') {
                const start = new Date(item.startDate);
                const end = new Date(item.endDate);
                // Add 1 day to get inclusive length
                const length = (end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24) + 1;
                
                // Use toLocaleDateString for formatting, ensuring UTC dates are read correctly
                const startDate = new Date(item.startDate + 'T00:00:00Z');
                const endDate = new Date(item.endDate + 'T00:00:00Z');

                return `
                    <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center mb-2 shadow-sm border-l-4 border-red-300">
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-700">
                                ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' })}
                            </span>
                            <span class="text-xs text-gray-500">
                                ${startDate.toLocaleDateString('en-US', { year: 'numeric', timeZone: 'UTC' })}
                            </span>
                        </div>
                        <div class="text-sm font-medium text-red-500">
                            ${Math.round(length)} days
                        </div>
                    </div>
                `;
            } else if (type === 'lab') {
                 const reportDate = new Date(item.reportDate + 'T00:00:00Z');
                 return `
                    <div class="bg-gray-50 p-3 rounded-lg flex flex-col mb-2 shadow-sm border-l-4 border-teal-400">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-700">
                                Report Date: ${reportDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' })}
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs font-medium text-gray-600">
                            <div>TSH: <span class="font-bold text-teal-600">${item.tsh}</span></div>
                            <div>T3: <span class="font-bold text-teal-600">${item.t3}</span></div>
                            <div>T4: <span class="font-bold text-teal-600">${item.t4}</span></div>
                        </div>
                        ${item.cbcDetails ? `<p class="mt-1 text-xs text-gray-500 italic">CBC Notes: ${item.cbcDetails}</p>` : ''}
                    </div>
                `;
            }
        };

        const renderApp = () => {
            // 1. User ID Display
            document.getElementById('user-id-display').textContent = `Local User ID: ${state.userId}`;

            // 2. Error Banner
            const errorBanner = document.getElementById('error-banner');
            if (state.error) {
                errorBanner.classList.remove('hidden');
                document.getElementById('error-message').textContent = state.error;
            } else {
                errorBanner.classList.add('hidden');
            }

            // 3. Cycle Metrics
            const stats = state.stats;
            const cycleStatsContainer = document.getElementById('cycle-stats');
            cycleStatsContainer.innerHTML = [
                renderStatCard('clock', 'Avg Cycle Length', stats.avgCycleLength ? `${stats.avgCycleLength} days` : 'N/A', 'text-indigo-500'),
                renderStatCard('droplet', 'Avg Period Length', stats.avgPeriodLength ? `${stats.avgPeriodLength} days` : 'N/A', 'text-red-500'),
                renderStatCard('calendar', 'Next Period Est.', stats.predictedNextPeriod || 'N/A', 'text-purple-500'),
                renderStatCard('activity', 'Ovulation Est.', stats.predictedOvulation || 'N/A', 'text-pink-500'),
            ].join('');

            document.getElementById('cycle-status').textContent = `Cycle Status: ${stats.healthStatus}`;
            document.getElementById('cycle-chart-container').innerHTML = renderCycleChart(state.stats.cycleHistoryData, state.stats.avgCycleLength);

            // 4. Latest Thyroid Status
            document.getElementById('latest-thyroid-status').innerHTML = renderThyroidStatus(state.latestThyroidStatus);

            // 5. AI Advisor
            const adviceDisplay = document.getElementById('ai-advice-display');
            if (state.loadingAI) {
                adviceDisplay.innerHTML = `<div class="text-center py-4 text-indigo-600"><svg class="animate-spin h-5 w-5 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-sm font-medium">Analyzing combined hormonal data...</p></div>`;
            } else if (state.aiAdvice) {
                 // Simple markdown-to-html for paragraphs and lists 
                let htmlAdvice = state.aiAdvice
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/\n/g, '<br />'); // Newlines
                // Use a DOM property to set HTML, which is safer and more robust
                adviceDisplay.innerHTML = `<div class="bg-white p-3 rounded-lg border border-indigo-100 text-sm text-gray-700">${htmlAdvice}</div>`;
            } else {
                adviceDisplay.innerHTML = "Log some data and click below for a holistic health assessment.";
            }

            const fetchBtn = document.getElementById('fetch-advice-btn');
            fetchBtn.disabled = state.loadingAI; 
            fetchBtn.textContent = state.loadingAI ? 'Analyzing...' : 'Get Holistic Health Assessment';


            // 6. History Logs
            const cycleHistoryContainer = document.getElementById('cycle-history');
            const labHistoryContainer = document.getElementById('lab-report-history');
            
            if (state.cycles.length === 0) {
                cycleHistoryContainer.innerHTML = '<div class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg"><p>No cycles logged yet.</p></div>';
            } else {
                cycleHistoryContainer.innerHTML = state.cycles.map(c => renderHistoryItem(c, 'cycle')).join('');
            }

            if (state.labReports.length === 0) {
                labHistoryContainer.innerHTML = '<div class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg"><p>No lab reports logged yet.</p></div>';
            } else {
                labHistoryContainer.innerHTML = state.labReports.map(r => renderHistoryItem(r, 'lab')).join('');
            }
            
            // Re-render Lucide icons after updating innerHTML
            lucide.createIcons();
        };

        // --- Modal Handling ---

        const showModal = () => {
            document.getElementById('confirmation-modal').classList.remove('hidden');
            // Ensure modal icon is rendered
            lucide.createIcons();
        };

        const hideModal = () => {
            document.getElementById('confirmation-modal').classList.add('hidden');
        };

        const handleDeleteClick = () => {
            showModal();
        };

        const handleConfirmDelete = () => {
            clearAllData();
            hideModal();
        };


        // --- Local Storage Initialization ---

        const initializeLocalStorage = () => {
            // Load data on startup
            const initialCycles = loadData(STORAGE_KEYS.CYCLES);
            const initialLabReports = loadData(STORAGE_KEYS.LAB_REPORTS);

            // Sort data by date descending (most recent first)
            initialCycles.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            initialLabReports.sort((a, b) => new Date(b.reportDate) - new Date(a.reportDate));

            const newStats = calculateStatsAndPredictions(initialCycles);
            const newThyroidStatus = getLatestThyroidStatus(initialLabReports);

            updateState({
                cycles: initialCycles,
                labReports: initialLabReports,
                stats: newStats,
                latestThyroidStatus: newThyroidStatus,
                loadingData: false,
            });
            
            // Ensure main content is visible on load
            document.getElementById('main-content').classList.remove('hidden');
        };

        // --- Form Handlers (Saving to Local Storage) ---

        const handleCycleFormSubmit = async (e) => {
            e.preventDefault();
            const startInput = document.getElementById('startDate').value;
            const endInput = document.getElementById('endDate').value;
            const errorElement = document.getElementById('cycle-form-error');
            const button = document.getElementById('log-cycle-btn');
            
            const start = parseDate(startInput);
            const end = parseDate(endInput);

            errorElement.classList.add('hidden');
            if (!start || !end || new Date(end) < new Date(start)) {
                errorElement.textContent = 'Please select valid start and end dates (end date must be on or after start date).';
                errorElement.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Recording...';
            try {
                const newCycle = { 
                    id: generateId(), 
                    startDate: start, 
                    endDate: end, 
                    timestamp: Date.now() 
                };
                
                // Add new cycle and sort by start date (descending)
                const newCycles = [newCycle, ...state.cycles].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                saveData(STORAGE_KEYS.CYCLES, newCycles);

                // Recalculate and update state manually
                const newStats = calculateStatsAndPredictions(newCycles);
                updateState({ cycles: newCycles, stats: newStats, loadingData: false });

                // Reset form fields
                const today = parseDate(new Date().toISOString());
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;

            } catch (e) {
                console.error("Error adding cycle data to local storage: ", e);
                errorElement.textContent = 'Failed to save period to local storage.';
                errorElement.classList.remove('hidden');
            } finally {
                button.disabled = false;
                button.textContent = 'Record Cycle';
            }
        };
        
        const handleLabReportFormSubmit = async (e) => {
            e.preventDefault();
            const dateInput = document.getElementById('reportDate').value;
            const tshInput = document.getElementById('tsh').value;
            const t3Input = document.getElementById('t3').value;
            const t4Input = document.getElementById('t4').value;
            const cbcDetailsInput = document.getElementById('cbcDetails').value;
            const errorElement = document.getElementById('lab-form-error');
            const button = document.getElementById('log-lab-btn');

            const date = parseDate(dateInput);
            const parsedTsh = parseFloat(tshInput);
            const parsedT3 = parseFloat(t3Input);
            const parsedT4 = parseFloat(t4Input);

            errorElement.classList.add('hidden');
            if (!date || isNaN(parsedTsh) || isNaN(parsedT3) || isNaN(parsedT4)) {
                errorElement.textContent = 'Please fill in the date and ensure TSH, T3, T4 are valid numbers.';
                errorElement.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Recording...';
            try {
                const newReport = {
                    id: generateId(),
                    reportDate: date,
                    tsh: parsedTsh,
                    t3: parsedT3,
                    t4: parsedT4,
                    cbcDetails: cbcDetailsInput,
                    timestamp: Date.now(),
                };
                
                // Add new report and sort by report date (descending)
                const newReports = [newReport, ...state.labReports].sort((a, b) => new Date(b.reportDate) - new Date(a.reportDate));
                saveData(STORAGE_KEYS.LAB_REPORTS, newReports);

                // Recalculate and update state manually
                const newThyroidStatus = getLatestThyroidStatus(newReports);
                updateState({ labReports: newReports, latestThyroidStatus: newThyroidStatus });

                // Reset form fields
                document.getElementById('reportDate').value = parseDate(new Date().toISOString());
                document.getElementById('tsh').value = '';
                document.getElementById('t3').value = '';
                document.getElementById('t4').value = '';
                document.getElementById('cbcDetails').value = '';

            } catch (e) {
                console.error("Error adding lab report to local storage: ", e);
                errorElement.textContent = 'Failed to save lab report to local storage.';
                errorElement.classList.remove('hidden');
            } finally {
                button.disabled = false;
                button.textContent = 'Record Lab Report';
            }
        };

        // --- Main Execution ---

        window.onload = () => {
            // Initialize from local storage instead of Firebase
            initializeLocalStorage();
            
            // Set current date on date inputs
            const today = parseDate(new Date().toISOString());
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('reportDate').value = today;

            // Attach event listeners
            document.getElementById('cycle-form').addEventListener('submit', handleCycleFormSubmit);
            document.getElementById('lab-report-form').addEventListener('submit', handleLabReportFormSubmit);
            
            // (MODIFIED) Point the button to the new gatekeeper function
            document.getElementById('fetch-advice-btn').addEventListener('click', getHolisticHealthAssessment);
            
            // Attach new event listeners for the Delete Modal
            document.getElementById('clear-data-btn').addEventListener('click', handleDeleteClick);
            document.getElementById('cancel-delete-btn').addEventListener('click', hideModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', handleConfirmDelete);
        };
    </script>
</body>
</html>
